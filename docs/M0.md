# M0 — Repository Setup and Tooling (Server-First Architecture)

## 1. Context

The project aims to develop a modular chess AI where the **Rust engine runs as a server process** accessed by a **TypeScript/React frontend** over HTTP and WebSocket.

This milestone establishes the **infrastructure foundation**: repository structure, toolchains, CI configuration, and coding standards that guarantee consistent builds across environments.

Subsequent milestones (M1–M9) depend on this setup to ensure reproducible builds and maintainable integration between Rust and TypeScript ecosystems.

---

## 2. Functional Scope

- Create a monorepo supporting **multi-language builds**:
  - Rust workspace (`crates/`, `services/`)
  - Node workspace (`apps/`, `packages/`)
- Provide developer ergonomics:
  - Linting, formatting, pre-commit hooks
  - Cross-platform scripts (`pnpm`, `cargo`)
- Configure CI to:
  - Run type checks, linting, and tests in parallel
  - Build both ecosystems
- Define basic folder layout:

---

## 3. Non-Functional Requirements

| Area                  | Requirement                                    |
| --------------------- | ---------------------------------------------- |
| Build reproducibility | Same output under identical toolchain versions |
| CI speed              | ≤10 min for full matrix (Rust + Node)          |
| Developer setup       | ≤5 min from clone to successful build          |
| Code style            | Uniform via `rustfmt`, `eslint`, `prettier`    |
| Platform support      | Linux + macOS (Windows optional)               |

---

## 4. Technical Design

### 4.1 Repository Layout

Monorepo managed with **pnpm workspaces** and a **Cargo workspace**:

- `Cargo.toml` at root defines all Rust crates.
- `pnpm-workspace.yaml` defines JS subprojects.
- Shared `.editorconfig`, `.prettierrc`, `.eslintrc.cjs`.

### 4.2 Toolchain Pinning

- Rust toolchain pinned via `rust-toolchain.toml` (`stable`, `rustfmt`, `clippy`).
- Node ≥ 18 LTS pinned in `.nvmrc`.
- `pnpm` version recorded in CI setup step.

### 4.3 Continuous Integration

- **GitHub Actions** workflow:
- Install Rust + Node toolchains.
- Build all crates (`cargo check --workspace`).
- Lint + typecheck JS projects.
- Run test suites (`cargo test`, `pnpm test`).
- Caches Cargo and pnpm dependencies.
- Enforces formatting check: `cargo fmt -- --check`.

### 4.4 Local Development Flow

1. Clone repo
2. Run `pnpm i`
3. Run `cargo build --workspace`
4. Run `pnpm dev` in `apps/web` (starts Vite)
5. Optional: `cargo run -p engine-server`

### 4.5 Environment Setup

- `make setup` or `scripts/setup.sh` installs dependencies.
- Developer documentation in `/docs/README.md`.

---

## 5. Risks & Mitigations

| Risk                               | Mitigation                   |
| ---------------------------------- | ---------------------------- |
| Toolchain drift between devs       | Pin versions, enforce via CI |
| CI build time grows too long       | Use cache + matrix builds    |
| Platform-specific bugs             | Build/test on Linux + macOS  |
| Formatting/linting inconsistencies | Pre-commit hooks + CI gate   |

---

## 6. Testing Plan

- **Build test:** run `cargo check` and `pnpm build` successfully on clean clone.
- **Lint test:** run `cargo clippy` + `eslint . --ext .ts,.tsx` → 0 errors.
- **CI smoke test:** verify GH Actions pipeline completes in < 10 min.
- **Cross-platform check:** build and run minimal demo on macOS + Linux.

---

## 7. Definition of Done (DoD)

✅ Monorepo layout finalized (`crates/`, `services/`, `apps/`, `packages/`, `docs/`).
✅ Toolchains pinned and documented.
✅ CI pipeline green on `main` for Linux + macOS.
✅ `cargo check --workspace` and `pnpm build` succeed with no warnings.
✅ Shared coding standards applied (`rustfmt`, `prettier`, `eslint`).

---

## 8. Next Step

Proceed to **[M1 — Shared Protocol Contract](./M1-shared-protocol-contract.md)** to define the cross-language API between the Rust engine and the TypeScript frontend.
